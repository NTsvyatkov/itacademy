{% extends "layout.html" %}
{% block body %}

 <script type="text/javascript">

     var tr = [];

            $(document).ready (function() {
            var count_tr=$('#table_size').val();
            var count_td=6;
            var page = 1;
            var table_grid = document.getElementById('grid');

            function creat_grid(count)
                {
                    for (var i=1; i<=count;i++ )
                        {
                            tr[i] = document.createElement('TR');
                            table_grid.appendChild(tr[i]);
                            tr[i].id=i;
                            if (i % 2 == 0) tr[i].style.background = "#c0c0c0";
                            for (var j=0; j<=8; j++)
                                {
                                    tr[i].appendChild(document.createElement('TD'));
                                }
                        }
                    $( "tr:even" ).css( "background-color", "#c0c0c0" );
                }

            function deleting_grid()
                {
                    for (var n=table_grid.rows.length ; n>=2; n--)
                        {
                            table_grid.removeChild(table_grid.childNodes[n]);
                        }

                }




    $('#search_button').click(function(){
    creat_grid();
    });


  function delete_id(id,grid_length)
  {
   $.ajax({
       dataType: "json",
        url: '/api/user_/'+id,
        type: 'DELETE',
        success: function(json)
                    {
                        if (json.message == 'success')
                         {
                          alert('The user has been successfully deleted');
                           if (grid_length==1)
                           {
                               if (page!=1)
                                {page=page-1;}
                           }
                          gridPagination();
                         }
                        else
                         alert (json.message);
                    },

        error: function(e)
                    {
                       error = JSON.parse(e.responseText);
                       alert(error.message);
                    }

   })
  }

  function ajax_success(json)
  {
           deleting_grid();
           var grid_length = json.users.length;
           creat_grid(grid_length,count_td);
           var k=0;

            for (var user_k in json.users)
                {
                 k++;
                 tr=table_grid.rows[k];
                 user_id=json.users[user_k].id;
                 tr.cells[0].innerHTML = '<span class = id_user>'+user_id+'</span>';
                 tr.cells[1].innerHTML = json.users[user_k].login;
                 tr.cells[2].innerHTML = '<span class=name>'+json.users[user_k].first_name+'</span>';
                 tr.cells[3].innerHTML = '<span class=l_name>'+json.users[user_k].last_name+'</span>';
                 tr.cells[4].innerHTML = json.users[user_k].role_id;
                 tr.cells[5].innerHTML = json.users[user_k].email;
                 tr.cells[6].innerHTML = json.users[user_k].region_id;
                 tr.cells[7].innerHTML = "<img src='static/images/Text Edit.png' class='edit_img' alt=" + k + ">";
                 tr.cells[8].innerHTML = "<img src='static/images/delete.png' class='delete_img'  alt=" + k + ">";
                 tr.cells[7].abbr=k;
                 tr.cells[8].abbr=k;

                }

                $('.delete_img').click(function(){
                  var tr= $(this).closest('tr');
                  var user_id = this.alt;
                  var first_name=tr.children('td').children('.name').text();
                  if(confirm('Are you sure you want to delete user '+ first_name +' ?'))
                  {
                    delete_id(user_id,grid_length);
                   }
                 })

                $('.edit_img').click(function(){
                  var tr= $(this).closest('tr');
                  var user_id = tr.children('td').children('.user_id').text();
                  var first_name=tr.children('td').children('.name').text();
                  if(confirm('Edit '+ product_name +' ?')){
                    document.location.href = 'user/'+user_id+'';
                  }
                   }
                 );

            /*---------------------End creating table------------------------------------*/

  }



   function gridPagination(){
                $.ajax({
                dataType: "json",
                url: '/api/users?page='+page+'&table_size='+count_tr+'',
                type: 'GET',
                contentType: "application/json",
                success: function(json)
                    {
                        ajax_success(json);
                        records_amount=(json.records_amount);
                        records_per_page=(json.records_per_page);
                        pages_amount = Math.ceil(records_amount/records_per_page);
                        document.getElementById("page").innerHTML = page;
                        document.getElementById("pages_amount").innerHTML = pages_amount;

             if (page==1){
               $('#prev').prop('disabled', true);
               $('#first').prop('disabled', true);
               $('#prev').addClass("button_disable");
               $('#first').addClass("button_disable");
           } else {
               $('#prev').prop('disabled', false);
               $('#first').prop('disabled', false);
               $('#prev').removeClass("button_disable");
               $('#first').removeClass("button_disable");
               $('#prev').removeAttr("disabled");
               $('#first').removeAttr("disabled");
           }

           if (page==pages_amount){
               $('#next').prop('disabled', true);
               $('#last').prop('disabled', true);
               $('#next').addClass("button_disable");
               $('#last').addClass("button_disable");

           } else {
               $('#next').prop('disabled', false);
               $('#last').prop('disabled', false);
               $('#next').removeClass("button_disable");
               $('#last').removeClass("button_disable");
               $('#next').removeAttr("disabled");
               $('#last').removeAttr("disabled");
           }
                    }
                })
            }

            if (page==1){
                gridPagination();
            }

            $('#next').click(function(){
            if (page*records_per_page>=records_amount){page=page}
            else {page=page+1}
            gridPagination()
            });

            $('#prev').click(function(){
            page=page-1;
            if (page<=1){
            page=1;
            }
            gridPagination()
            });

            $('#first').click(function(){
            page=1;
            gridPagination()
            });

            $('#last').click(function(){
            page=pages_amount;
            gridPagination()
            });

            $('#table_size').change(function () {
            count_tr=$('#table_size').val();
            $( "#table_siz option:selected" ).each(gridPagination())
            })

            });
   </script>

  </head>


  <body>

  <div id="user_block">
This page is appointed for creating new and managing existing users
<div>
     <a href='create_user' style='margin-left:50px; color:black; text-decoration:none;'>
     <input type='button' value="Create New User">
     </a>
 </div>

      <div id="user_filter">

        <div class="user_filter_in">
         <form class='form'>
		 <span>Search user</span>
<table>
   <tr>
	<td>
		 <div class="search">
         <select id="SelectId_user"  style="width:100px">
			<option value="str0"> User Name </option>
			<option value="str1"> first name </option>
			<option value="str2"> last name </option>
			<option value="str3"> email </option>
			<option value="str4"> Role </option>
			<option value="str5"> All Columns </option>
			 </select>
			</div>
	</td>
	<td>
		<div class="search">
		 <select id="SelectId_key"  style="width:100px">
			<option value="str0"> start with </option>
			<option value="str1"> equals </option>
			<option value="str2"> contains </option>
			<option value="str3"> not equal to </option>
			<option value="str4"> does not contain </option>
		 </select>
		</div>
  	</td>
  	<td>
  		<input type="text" style="width:280px" />
		<input type="button" value="search" id='search_button'>
	</td>
   </tr>
</table>
         </form>
		 </div>
          </div>

              <div id="user_table">
              <div class="field" style="margin-left:5%;">
                  <lable>Table size: </lable>
                  <select id="table_size" class="span1">
                    <option selected>5</option>
                    <option>25</option>
                   </select>
            </div>
       <table id='grid' class="grid">
           <tr>
               <th>
                   User ID
               </th>
               <th>
                   Login
               </th>
               <th>
                   First Name
               </th>
               <th>
                   Last Name
               </th>
               <th>
                   Role
               </th>
			   <th>
                   Email
               </th>
               <th>
                   Region
               </th>
               <th>
                   Edit
               </th>
               <th>
                   Delete
               </th>

           </tr>
       </table>

            <div id="pagination" style="text-align: center">
                <input type="button" id="first" value="First">&nbsp
                <input type="button" id="prev" value="Prev">&nbsp

                <input type="button" id="next" value="Next">&nbsp
                <input type="button" id="last" value="Last">
                <div style="font-size:14px; color:#606860;">Page <span id="page"></span> of <span id="pages_amount"></span></div>
            </div></div></div>



{% endblock body %}
