{% extends "layout.html" %}
{% block body %}


<script src="{{ url_for('static', filename='js/datepicker/jquery.ui.core.js') }}"></script>
<script src="{{ url_for('static', filename='js/datepicker/jquery.ui.widget.js') }}"></script>
<script src="{{ url_for('static', filename='js/datepicker/jquery.ui.datepicker.js') }}"></script>
<script type="text/javascript">

/* JQueri UI  - Datapicker options*/
	$(function() {
		$( "#expire_date" ).datepicker({
          changeMonth: true,
          changeYear: true,
          showButtonPanel: true,
          dateFormat: 'yy/mm',
          onClose: function(dateText, inst) {
            var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
            var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
            $(this).datepicker('setDate', new Date(year, month, 1));
        }
		});

		$( "#start_date" ).datepicker({
          changeMonth: true,
          changeYear: true,
          disabled: true,
          showButtonPanel: true,
          dateFormat: 'yy/mm',
          onClose: function(dateText, inst) {
            var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
            var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
            $(this).datepicker('setDate', new Date(year, month, 1));
        }
		});
	});
/*--------------------------*/

  var order_id=0;
  var maestro_card = false;

$(document).ready(function() {

    $('#issue_number').attr('readonly',true);
    $('#issue_number').css('background-color','#e2e2e2');
    var count_tr=10;
    var count_td=6;
    var tr = [];
    var page = 1;
    var error_list =[];
    /* Creating table of products */
    var table_grid = document.getElementById('grid');
    function create_grid(count_tr, count_td)
    {
        for (var i=1; i<=count_tr;i++ )
        {
            tr[i] = document.createElement('TR');
            table_grid.appendChild(tr[i]);
            tr[i].id=i;
            if (i % 2 == 0) tr[i].style.background = "#c0c0c0"; /* .className = 'tr_style' */
            for (var j=0; j<=count_td; j++)
             {
              tr[i].appendChild(document.createElement('TD'));
             }
        }
    }

    create_grid(count_tr,count_td);
  /*End of creating table*/

  /*Create "Delivery option's" select */
 var arr =[
 {%for i in dimensions_arr %}
 {val : {{ i.id }} , text: '{{i.name}}'},
 {% endfor %}
          ];
  var select = $('#delivery_options')
  $(arr).each(function() {
    select.append($("<option>").attr('value',this.val).text(this.text));
  });
 /*End  ------------------------ select */

  function clearing_tr(i)
  {
      for (var j=0; j<=6; j++)
      {
          tr[i].cells[j].innerHTML='';
      }
  }


  function clearing_grid()
  {
    for (var n=2 ; n<=count_tr; n++)
    {
      clearing_tr(n);
    }
  }

 function deleting_grid()
 {
    for (var n=table_grid.rows.length ; n>=2; n--)
      {
       table_grid.removeChild(table_grid.childNodes[n]);
      }

 }

ajax_pull('Grid','GET','data');
/* Ajax function for put and get methods*/
 function ajax_pull(success_option,type_options,data){
       $.ajax({
        dataType: "json",
        url: '/api/order_product',
        type: type_options,
        contentType: "application/json",
        data:data,
        success: function(json)
        {
            if (success_option == 'Grid'){
             ajax_success(json);
             }
             else {
              alert('Order successfully issued');
              ajax_pull('Grid','GET','data');
              }
         }
      })
 }
/*------------------------------------------*/


    $('#apply_button').click(function(){
    create_entity();
    });


  function delete_id(id)
  {
  if (id=='') id=0;
   $.ajax({
       dataType: "json",
        url: '/api/order_product/'+id+'/'+order_id,
        type: 'DELETE',
        contentType: "application/json",
        success: function(json)
                    {
                        if (json.message == 'success')
                         {
                          alert('The product has been successfully deleted from the cart');
                          ajax_pull('Grid','GET','data');
                         }
                        else
                         alert (json.message);
                    },

        error: function(e)
                    {
                       error = JSON.parse(e.responseText);
                       alert(error.message);
                    }

  })
 }
 /*Function ajax_success parse Json and add values in table - grid  */
  function ajax_success(json){
           deleting_grid();
           create_grid(json.order.length,count_td);
           var k=0;
           /*Create table with new order_products list */
            for (var product_k in json.order)
               {
                 k++;
                 order_id=json.order[product_k].order_id;
                 product_name =json.order[product_k].name;
                 id_product =json.order[product_k].id;
                 tr[k].cells[0].innerHTML =product_name;
                 tr[k].cells[1].innerHTML = json.order[product_k].description;
                 tr[k].cells[2].innerHTML = json.order[product_k].dimension +
                         '<input class="dimension" value="'+json.order[product_k].dimension_id+'" type="hidden">';
                 tr[k].cells[3].innerHTML = "<span class='price'>"+json.order[product_k].price.toFixed(2)+"</span>";
                 input = "<input type='text' class='quantity' value='"+json.order[product_k].quantity+"'\
                        alt='"+json.order[product_k].id+"' style='width:60px'>\
                        <input type='button' value='update' class='update_amount'> \
                          <div class='error_div'></div>";

                 tr[k].cells[4].innerHTML = input;
                 if (json.order[product_k].quantity) quant= Math.round(json.order[product_k].quantity); else quant= 0;
                 var amount= (+json.order[product_k].price * +quant).toFixed(2);
                 tr[k].cells[5].innerHTML = "<span class='amount'>"+amount+"</span>";
                 tr[k].cells[6].innerHTML = "<img src='static/images/delete.png' class='delete_img'\
                 id='"+product_name+"' alt=" + json.order[product_k].id + " >";
               }

                $('#total_amount').text('Total amount: ' + get_total_amount().toFixed(2));


            /*End creating table*/

                $('.delete_img').click(function(){
                  if(confirm('Are you sure that you want to remove '+ this.id +' from the cart?'))
                  {
                    delete_id(this.alt);
                   }
                 })

                $('tr input.update_amount').click(function(){
                   var tr= $(this).closest('tr');
                   var price = tr.children('td').children('.price').text();
                   var quantity = Math.round($(this).prev().val());
                       $(this).prev().val(quantity);
                   if(!(quantity/quantity)||(quantity==0)){  /*Check on numeric */
                      $('.error_div').empty();
                      $(this).next('.error_div').html('Quantity should be numeric and not 0');
                     }
                    else{
                     $('.error_div').empty();
                     var sum = +price*+quantity;
                     tr.children('td').children('.amount').text(sum.toFixed(2));
                     $('#total_amount').text('Total amount: ' + get_total_amount().toFixed(2));
                     }
                })

  }
/*----------------------------END of ajax_success ------------------------------------*/


  function get_total_amount()
  {
   var total =0;
   for( var i=0, total=0; i<$('.amount').size(); i++)
   {
    total = +$('.amount:eq('+i+')').text() + +total;
   }
   return total;
  }


 $('#add_order').click(function(){
    /* Clear error and border-color*/
      if(error_list)
      {
          for (i in error_list)
           {
             var object1=error_list[i].id;
             object1.css('border-color','#999');
             object1.next('.error_div').remove();
           }
          error_list=[];
      }
     /*---------------------------------*/

       var error='';
       var no_error = true
       var clear_list;

      /* String length validation */
       if  (($('#input_address').val().length >50) || ($('#input_address').val().length == 0))
       {
        no_error = false;
        error ='Address string should be less then 50 characters , but not 0 character';
        error_list.push({id:$('#input_address'), error:error});
       }
       if  ($('#input_comments').val().length >1500)
       {
        no_error = false;
        error ='Comment string should be less then 1500 characters';
        error_list.push({id:$('#input_comments'), error:error});
       }

       for( var i=0, total=0, k=0; i<$('.quantity').size(); i++)
         {
          quantity = $('.quantity:eq('+i+')').val();

          if(!(quantity/quantity)||(quantity==0) && k != 1 ){  /*Check on numeric */
              error = 'Quantity should be numeric and not 0';
              k= 1;
              no_error = false;
              error_list.push({id:$('#order_error'), error:error});
            }
         }

      /*-----------End of Strings length validation---------*/

      /*Credit card numbers validation*/
       r_e=/^[0-9]{16}$/;
       credit_number = $('#credit_card_number').val();

       if (r_e.test(credit_number)){}
       else
       {
         no_error = false;
         error = 'Number of credit card is illegal. It should be 16 it should be one digits!';
         error_list.push({id: $('#credit_card_number'), error:error});
       }

       r_e_ccv2=/^[0-9]{3}$/;
       cvv2_number = $('#cvv2_number').val();

      if (r_e_ccv2.test(cvv2_number)) {}
      else
       {
          no_error=false;
          error='CVV2 number is wrong. it should be 3 digits!';
          error_list.push({id:$('#cvv2_number'), error:error});
       }

      issue_number =$('#issue_number').val();
      if  ((maestro_card == true) && (issue_number ))
      {
       r_e_issue_number=/^[0-9]{1}$/;
       if (r_e_issue_number.test(issue_number)){}
       else{
         no_error=false;
         error='Issue number format is wrong. it should be one digit or none!';
         error_list.push({id:$('#issue_number'), error:error});
       }
      }

      /*Credit card date validation*/

      date_expire= $('#expire_date').val().replace('/', '-')+'-01';

       if (!Date.parse(date_expire))
         {
             no_error = false;
             error='Expire date have wrong format, please use calendar';
             error_list.push({id:$('#expire_date'), error:error});
         }

      if (maestro_card == true)
      {
          date_start= $('#start_date').val().replace('/', '-') + '-01';

         if (Date.parse(date_start) > Date.parse(date_expire))
         {
             no_error = false;
             error='Start date of card can not be more then Expire date';
             error_list.push({id:$('#start_date'), error:error});
         }
          if (!Date.parse(date_start))
         {
             no_error = false;
             error='Start date have wrong format, please use calendar';
             error_list.push({id:$('#start_date'), error:error});
         }

      }




      /*--------------------End of Credit card validation----------------------*/
       if (no_error){

          /*Clear error message*/
         $('.error_div').empty();
          /*-----------------*/

         /*add all quantity and product_id in array */
         var product_arr=[];
         for( var i=0, total=0; i<$('.quantity').size(); i++)
         {
         product_arr[i]= {'quantity':+$('.quantity:eq('+i+')').val(),'product_id':+$('.quantity:eq('+i+')').attr('alt'),
                          'dimension_id':$('.dimension:eq('+i+')').val()}
         }
        /*------------------*/

         form_value = { order_id:order_id, delivery_type:$('#delivery_options').val(),
                        delivery_address: $('#input_address').val(), comment:$('.comments_area').val(),
                        credit_card_options:$('#credit_card_options').val(),
                        credit_card_number:$('#credit_card_number').val(),
                        cvv2_number:$('#cvv2_number').val(), expire_date:$('#expire_date').val(),
                        cvv2_number:$('#start_date').val(), expire_date:$('#issue_number').val(),
                        product_quantity:product_arr};

         /* Json for put on server*/
         json_value = JSON.stringify(form_value);
         /*-----------------------*/
         ajax_pull('Alert','PUT',json_value);
       }
        else{
            $('.error_div').empty();
           for (i in error_list)
           {
             var object1=error_list[i].id;
             object1.closest('div').append('<p class=error_div>'+error_list[i].error+'');
             object1.css('border-color','#b81900');

           }

         }
   })
 /* Car select-or event change*/

  $('#credit_card_options').change(function () {
      if ($('#credit_card_options').val() != 4)
      {
         $('#start_date').datepicker( "option", "disabled", true );
         $('#issue_number').attr('readonly',true);
         $('#issue_number').css('background-color','#e2e2e2');

      }
      else
      {
          $('#start_date').datepicker( "option", "disabled", false );
          $('#issue_number').attr('readonly',false);
          $('#issue_number').css('background-color','white');
          maestro_card = true;

      }
  })
 /*-----------------------------------*/

 /* What is this CVV2 --- alert  */
  $('#cvv2_info').click(function(){

    alert('The CVV2 code stands for Card Verification Value 2. The CID code stands for Card Identification.'+
          'It is a security feature on credit cards used to improve the security of transactions. It consists of ' +
          'a 3 or 4 digit number printed, but not raised, on the back of the credit card.');
  })
 /*---------------------------*/

})



   </script>




  <div id="products_block">
      <div id="products_filter">

      </div>
      <div id="products_table">
       <table id='grid' class="grid">
           <tr>

                <th>
                   Product name
               </th>
               <th>
                   Description
               </th>
               <th>
                   Dimension
               </th>
                <th>
                   Price
               </th>
               <th>
                   Quantity
               </th>
               <th>
                   Amount
               </th>
               <th>
                   Delete
               </th>
           </tr>
       </table>

      </div>
          <div style="clear:both;"></div>

      <div class="product_filter_in" style=" margin:0px auto; ">
         <div class="ProductTitle" id="total_amount" style="width:75%; text-align:right;" >
             Total amount:
         </div>
       <div style="width:850px; margin:0 auto;">
        <div class="order_block">

           <div class="field">
               <lable>Delivery Type: </lable>
               <select id="delivery_options" style="width:165px;">

               </select>
           </div>
           <div class="field">
               <lable>Delivery Address: </lable>
               <input type="text" id="input_address">
           </div>

           <div class="field">
               <lable>Comments: </lable>
               <textarea class="comments_area" id="input_comments"></textarea>
           </div>
           <div class="field">
              <input type="button" id="add_order" value="Place an order">
           </div>
           <div class="field">
             <div class="error_div" id="order_error"> </div>
           </div>

        </div>

        <div class="order_block">
            <span style='margin-left:10px; font-weight: bold;'>Card Info</span>
           <div class="field">
            <lable>Credit Card Type:<span class='red_star'>*</span> </lable>
               <select id="credit_card_options" style="width:165px;">
                 <option value=1>Visa</option>
                 <option value=2>MasterCard</option>
                 <option value=3>American Express</option>
                 <option value=4>Maestro</option>
               </select>
            </div>
            <div class="field">
               <lable>Credit Card Number:<span class='red_star'>*</span> </lable>
               <input type="text" id="credit_card_number">
            </div>
            <div class="field">
               <lable>CVV2 Code <span class='red_star'>*</span>: <span id='cvv2_info' style='text-decoration: underline; font-size: 10px;'>
                   What is this? </span>
               </lable>
               <input type="text" id="cvv2_number">
            </div>

            <div class="field">
               <lable>Expiry Date <span class='red_star'>*</span>:</lable>
               <input type="text" id="expire_date">
            </div>

            <div class="field">
               <lable>Start Date<span class='red_star'>*</span>: <span style="font-size:9px;">For Maestro</span></lable>
               <input type="text" id="start_date">
            </div>

            <div class="field">
               <lable>Issue Number: <span class='red_star'>*</span><span style="font-size:9px;">For Maestro</span></lable>
               <input type="text" id="issue_number">
            </div>
             <div class="field">

            </div>

        </div>
              <div style="clear:both;"></div>
        </div>


      </div>
</div>
{% endblock body %}
